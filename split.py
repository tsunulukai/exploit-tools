#!/usr/bin/env python3

"""
Usage:
    split.py <file> [-b <begin>] [-e <end>] [-s <step>] [-o <outdir>]

Options:
    -f <file>       Specify the file to split
    -b <offset>     Offset begin
    -e <offset>     Offset end
    -s <s>          Step
"""

import docopt
import os

def main():
    arguments = docopt.docopt(__doc__)
    if arguments["<file>"]:
        if os.path.isfile(arguments["<file>"]):
            file = arguments["<file>"]

    c = open(file,'rb').read()

    if arguments["-s"]:
        if arguments["-s"][0:2] == "0x":
            step = int(arguments["-s"],16)
        else:
            step = int(arguments["-s"])
    else:
        step = 0x1000

    if arguments["-b"]:
        if arguments["-b"][0:2] == "0x":
            begin = int(arguments["-b"],16)
        else:
            begin = int(arguments["-b"])
    else:
        begin = step

    if arguments["-e"]:
        if arguments["-e"][0:2] == "0x":
            end = int(arguments["-e"],16)
        else:
            end = int(arguments["-e"])
    else:
        end = len(c)

    if arguments["-o"]:
        outdir = arguments["<outdir>"]
    else:
        outdir = "./out"

    if not os.path.isdir(outdir):
        print("Output directory '%s' does not exist, creating it..." % outdir)
        os.mkdir(outdir)

    print("Splitting file %s from offset 0x%04x (%i) to 0x%04x (%i) by steps of 0x%04x (%i) bytes" % (file, begin, begin, end, end, step, step))

    for o in range(begin, end+step, step):
        print("Writing file to offset 0x%08x (%s)" % (o, o))
        fn = "%s-0x%08x" % (file, o)
        fn = outdir + "/" + fn
        of = open (fn, 'wb')
        of.write(c[:o])
        of.close


if __name__ == "__main__": 
    main()
